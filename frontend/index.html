<!DOCTYPE html>
<html>
	<head>
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		{HEAD}
		{CSS}
	</head>
	<body>
		<div class="header">
			{BODYHEADER}
		</div>
		<noscript>
			<p>
				This site really needs JavaScript!
			</p>
		</noscript>

		{JS}

		<script>
			$('<div class="contentarea"> \
				<div class="sidebar"> \
					<div class="constraintslistbox"></div> \
					<div class="eventdescriptionslistbox"></div> \
				</div> \
				<div class="selectorsarea"> \
					<ul class="nav nav-pills" id="tabbar"> \
						<li class="active"><a href="#facetstab" data-toggle="tab" title="Facets view">Facets</a></li> \
						<li><a href="#storyline" data-toggle="tab" title="Storyline">Storyline</a></li> \
						<li><a href="#timelinetab" data-toggle="tab" title="Timeline view">Timeline</a></li> \
						<li><a href="#maptab" data-toggle="tab" title="Map view">Map</a></li> \
						<li><a href="#tsnetab" data-toggle="tab" title="Cluster view">Cluster</a></li> \
						<li><a href="#textsearchtab" data-toggle="tab" title="Text search">Text search</a></li> \
					</ul> \
					<div class="tab-content" id="tabcontents"> \
						<div class="tab-pane active" id="facetstab"></div> \
						<div class="tab-pane" id="storyline"></div> \
						<div class="tab-pane" id="timelinetab"></div> \
						<div class="tab-pane" id="maptab"></div> \
						<div class="tab-pane" id="tsnetab"></div> \
						<div class="tab-pane" id="textsearchtab"></div> \
					</div> \
				</div> \
			</div>').appendTo($('body'));

			LayoutUtils.setupPanelled($('body'), $('.header'), $('.contentarea'), 'vertical', 4);
			LayoutUtils.setupPanelled($('.selectorsarea'), $('#tabbar'), $('.tab-content'), 'vertical');

			var initialQuery = new Queries.Query(FrontendConfig.backendUrl);
			var globalQuery = new Queries.Query(FrontendConfig.backendUrl);

			function setupSidebar(container, globalQuery) {
				var cnstrBoxElt = $(".constraintslistbox");
				var eventDescBoxElt = $(".eventdescriptionslistbox");

				ConstraintsList.setup(cnstrBoxElt, globalQuery);
				EventDescriptionsList.setup(eventDescBoxElt, globalQuery);

				LayoutUtils.setupPanelled(container, cnstrBoxElt, eventDescBoxElt, 'vertical', 0, true);
			}
			setupSidebar($(".sidebar"), globalQuery);

			var facetsExpanded = [];
			var facetMakers = $.map(FrontendConfig.facets, function (facet) {
				return function (container) {
					facetsExpanded.push(Utils.extendObject([facet], {
						constraintsQuery: Facet.setup(container, globalQuery, facet.title, facet.field)
					}));
				}
			});
			LayoutUtils.setupSplitMakeElements($('#facetstab'), 'horizontal', facetMakers);
			Storyline.setup($('#storyline'), globalQuery, facetsExpanded);
			Timeline.setup($('#timelinetab'), initialQuery, globalQuery);
			Map.setup($('#maptab'), initialQuery, globalQuery, mapDataUrl, FrontendConfig.minMapZoom, FrontendConfig.maxMapZoom);
			Tsne.setup($('#tsnetab'), initialQuery, globalQuery, FrontendConfig.minMapZoom, FrontendConfig.maxMapZoom);
			TextSearch.setup($('#textsearchtab'), globalQuery);

			LayoutUtils.fillElement($('.tab-content'), $('#facetstab'), 'vertical');
			LayoutUtils.fillElement($('.tab-content'), $('#storyline'), 'vertical');
			LayoutUtils.fillElement($('.tab-content'), $('#timelinetab'), 'vertical');
			LayoutUtils.fillElement($('.tab-content'), $('#maptab'), 'vertical');
			LayoutUtils.fillElement($('.tab-content'), $('#tsnetab'), 'vertical');
			LayoutUtils.fillElement($('.tab-content'), $('#textsearchtab'), 'vertical');
			LayoutUtils.fillElement($('.tab-content'), $('#abouttab'), 'vertical');

			// Update the queries only after setting up all the controls
			initialQuery.update();
			globalQuery.update();

			// Fake a window resize on changing tabs, so ensure that the contents are sized properly
			$('a[data-toggle="tab"]').on('shown', function () {
				$(window).trigger('resize');
			});
		</script>
	</body>
</html>
