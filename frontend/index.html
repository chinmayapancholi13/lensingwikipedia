<!DOCTYPE html>
<html>
	<head>
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		{HEAD}
		{CSS}
	</head>
	<body>
		<div class="header">
			{BODYHEADER}
		</div>
		<noscript>
			<p>
				This site really needs JavaScript!
			</p>
		</noscript>

		{JS}

		<script>
			function makeTabs(tabBar, tabContents, tabs, defaultTabId) {
				var foundDefault = false;
				$.each(tabs, function (tabI, tab) {
					var barElt = $('<li><a href="#' + tab.id + '" data-toggle="tab" title="' + tab.longname + '">' + tab.name + '</a></li>').appendTo(tabBar);
					var container = $('<div class="tab-pane" id="' + tab.id + '"></div>').appendTo(tabContents);
					fillElement($('.tab-content'), container, 'vertical');
					tab.make(container);
					if (tab.id == defaultTabId) {
						barElt.addClass('active');
						container.addClass('active');
						foundDefault = true;
					}
				});
				if (!foundDefault)
					console.log("warning: unknown default tab");
			}

			$('<div class="contentarea"> \
				<div class="sidebar"> \
					<div class="constraintslistbox"></div> \
					<div class="eventdescriptionslistbox"></div> \
				</div> \
				<div class="selectorsarea"> \
					<ul class="nav nav-pills" id="tabbar"> \
					</ul> \
					<div class="tab-content" id="tabcontents"> \
					</div> \
				</div> \
			</div>').appendTo($('body'));

			setupPanelled($('body'), $('.header'), $('.contentarea'), 'vertical', 4);
			setupPanelled($('.selectorsarea'), $('#tabbar'), $('.tab-content'), 'vertical');

			var initialQuery = new Query(backendUrl);
			var globalQuery = new Query(backendUrl);

			function setupSidebar(container, globalQuery) {
				var cnstrBoxElt = $(".constraintslistbox");
				var eventDescBoxElt = $(".eventdescriptionslistbox");

				setupConstraintList(cnstrBoxElt, globalQuery);
				setupEventDescriptionsList(eventDescBoxElt, globalQuery);

				setupPanelled(container, cnstrBoxElt, eventDescBoxElt, 'vertical', 0, true);
			}
			setupSidebar($(".sidebar"), globalQuery);

			// TODO there will be a merge conflict with the xkcd branch
			var facetsInfo = [];
			var facetMakers = $.map(facets, function (title, field) {
				return function (container) {
					var constraintsQuery = setupFacet(container, globalQuery,
							title, field);

					facetsInfo.push({
					    title: title,
					    field: field,
					    constraintsQuery: constraintsQuery
					});
				}
			});

			makeTabs($('#tabbar'), $('#tabcontents'), [
				{ id: "facetstab", name: "Facets", longname: "Facets view", make: function(elt) { setupSplitMakeElements(elt, 'horizontal', facetMakers) } },
				{ id: "timelinetab", name: "Timeline", longname: "Timeline view", make: function(elt) { setupTimeline(elt, initialQuery, globalQuery) } },
				{ id: "comparetab", name: "Comparison", longname: "Comparison view", make: function(elt) { setupCompare(elt, globalQuery, facetsInfo) } },
				{ id: "maptab", name: "Map", longname: "Map view", make: function(elt) { setupMap(elt, initialQuery, globalQuery, mapDataUrl, minMapZoom, maxMapZoom) } },
				{ id: "textsearchtab", name: "Text Search", longname: "Text Search", make: function(elt) { setupTextSearch(elt, globalQuery) } }
			], 'facetstab');

			// Update the queries only after setting up all the controls
			initialQuery.update();
			globalQuery.update();

			// Fake a window resize on changing tabs, so ensure that the contents are sized properly
			$('a[data-toggle="tab"]').on('shown', function () {
				$(window).trigger('resize');
			});
		</script>
	</body>
</html>
