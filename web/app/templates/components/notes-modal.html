<div id="notesModal" class="modal hide fade" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-header">
    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
    <h3>Notebook</h3>
  </div>
  <div class="modal-body">
    {# Don't set a default value here (i.e. don't get the first note in the
       template). You'll end up with a mess of using .text() and .val() which
       won't always work. .val() refers to what the user sees, and .text()
       refers to the stuff in between the open and close tag, and they're not
       the same thing.

       Just do it in Javascript.
     #}
    <textarea id="notesInput"></textarea>
  </div>
  <div class="modal-footer">
    <span class="modal-status" id="notesStatus"></span>
    <a href="#" data-dismiss="modal" aria-hidden="true" class="btn">Close</a>
    <a href="#" id="noteSave" class="btn btn-primary">Save note</a>
  </div>
</div>
<script>
$('#notesModal').on('hidden', function (e) {
  Utils.log("Hid notes");
})
$('#notesModal').on('shown', function (e) {
  Utils.log("Opened notes");
})
$(function() {
    // TODO error handling and security
    // try to get the first note
    var first_note_id = null;
    var notesInput = $("#notesInput");
    var notesStatus = $("#notesStatus");

    $.get('/api/notes', function(data) {
      if (data.ids.length != 0) {
        first_note_id = data.ids[0];
        $.get('/api/notes/' + first_note_id, function(data) {
          notesInput.val(data.contents);
        });
      } else {
        notesStatus.text("Couldn't find any notes on the server.");
      }
    });

    $("#noteSave").click(function() {
      var method;
      var endpoint;
      if (first_note_id === null) {
        method = 'POST';
        endpoint = '/api/notes';
      } else {
        method = 'PUT';
        endpoint = '/api/notes/' + first_note_id;
      }

      notesStatus.text("Saving...");

      $.ajax({
        url: endpoint,
        method: method,
        data: {
          contents: notesInput.val()
        },
        success: function() {
          notesStatus.text("Saved!");
        },
        error: function() {
          notesStatus.text("Failed to save. Please wait a few minutes and try again.");
        }
      });
    });
});
</script>
